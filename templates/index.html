<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Transcripteur Whisper</title>
    <script>
      (function () {
        const saved = localStorage.getItem('theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        window.__theme = saved || (prefersDark ? 'dark' : 'light');
        document.documentElement.setAttribute('data-theme', window.__theme);
      })();
    </script>
    <link rel="stylesheet" href="/static/style.css" />
    <link rel="icon" href="/static/icon.ico" type="image/x-icon">
  </head>
  <body>
    <header class="header">
      <div class="container header-row">
        <img id="logo" alt="Logo" />
        <button id="toggle-theme" type="button"></button>
        <script>
          const isDark = window.__theme === 'dark';
          document.getElementById('logo').src = isDark ? '/static/logo_white.png' : '/static/logo.png';
          document.getElementById('toggle-theme').textContent = isDark ? '‚òÄÔ∏è Mode clair' : 'üåô Mode sombre';
        </script>
      </div>
    </header>

    <main class="container card">
      <h1>Transcripteur mp3 ‚Üí txt via Whisper</h1>
      <p class="subtitle">Lot de fichiers ¬∑ Local ou API OpenAI</p>

      <form id="form" class="grid">
        <div class="field">
          <label for="mode">Mode de transcription</label>
          <select id="mode" name="mode">
            <option value="local">Local (CPU int8)</option>
            <option value="api">API OpenAI</option>
          </select>
        </div>

        <div class="field" id="api-key-wrap" hidden>
          <label for="api_key">Cl√© API OpenAI (facultatif si OPENAI_API_KEY est d√©fini)</label>
          <input id="api_key" name="api_key" type="password" placeholder="sk-..." />
        </div>

        <div class="field" id="output-type-wrap" hidden>
          <label for="output_type">Format de sortie</label>
          <select id="output_type" name="output_type">
            <option value="resume">R√©sum√©</option>
            <option value="compte_rendu">Compte-rendu</option>
            <option value="cahier_des_charges">Cahier des charges</option>
            <option value="notes_de_cadrage">Notes de cadrage</option>
          </select>
        </div>

        <div class="field">
          <label for="model">Mod√®le</label>
          <select id="model" name="model"></select>
        </div>

        <div class="field">
          <label for="lang">Langue</label>
          <select id="lang" name="lang"></select>
        </div>

        <div class="field full">
          <label for="files">Fichiers audio</label>
          <input id="files" name="files" type="file" multiple accept=".mp3,.wav,.m4a,.flac" />
          <small>Formats : mp3, wav, m4a, flac</small>
        </div>

        <div class="actions">
          <button id="start" type="submit">Lancer la transcription</button>
          <button id="reset" type="button" class="ghost">R√©initialiser</button>
        </div>
      </form>

      <section id="status" class="status" hidden>
        <div class="progress-wrap">
          <div class="progress" id="progress"></div>
        </div>
        <div class="meta">
          <span id="job-id"></span>
          <span id="job-state" class="badge">en attente</span>
        </div>

        <div id="files-list" class="files-list"></div>
        <pre id="logs" class="logs"></pre>

        <div id="downloads" class="actions" hidden>
          <button class="button ghost" id="btn-transcription" onclick="downloadTxt(currentJobId, 'transcription', true)">T√©l√©charger la transcription (TXT)</button>
          <button class="button ghost" id="btn-summary" hidden onclick="downloadTxt(currentJobId, 'summary', true)">T√©l√©charger le r√©sum√© (TXT)</button>
          <button class="button" id="btn-zip" onclick="downloadZip(currentJobId)">T√©l√©charger en ZIP</button>
        </div>
      </section>
    </main>

    <footer class="container muted">
      Whisper + VAD Silero ¬∑ API OpenAI optionnelle ¬∑ Fait par Romain Cieslik
    </footer>

    <!-- Config envoy√©e par le serveur (JSON pur, sans commentaire) -->
    <script id="whisper-config" type="application/json">
      {{ {
        "MODELS_LOCAL": models_local,
        "MODELS_CLOUD": models_cloud,
        "LANGS": langs,
        "DEFAULT_MODEL_LOCAL": DEFAULT_MODEL_LOCAL,
        "DEFAULT_LANG": DEFAULT_LANG
      } | tojson }}
    </script>

    <script src="/static/app.js" defer></script>
  </body>
</html>
